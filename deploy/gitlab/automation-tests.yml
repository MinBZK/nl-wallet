.run-automation-tests-common-setup:
  resource_group: automation-tests
  extends: .env-ont-k8s
  environment:
    action: access
  artifacts:
    when: always
    paths:
      - uiautomation/build/test-results
      - uiautomation/build/reports
    reports:
      junit: uiautomation/build/test-results/**/*.xml
  before_script:
    - export BROWSERSTACK_USER=$(kubectl get secret nl-wallet-browserstack -o jsonpath='{.data.user}' | base64 --decode)
    - export BROWSERSTACK_KEY=$(kubectl get secret nl-wallet-browserstack -o jsonpath='{.data.key}' | base64 --decode)
    - java -version
    - cd uiautomation
    - set -euxo pipefail

.run-automation-tests-default:
  extends: .run-automation-tests-common-setup
  script:
    - ./gradlew --no-daemon --info --stacktrace test --tests $TESTS
      -Dtest.config.app.identifier="${APP_IDENTIFIER}_${CI_COMMIT_SHA}"
      -Dtest.config.device.name="$DEVICE_NAME"
      -Dtest.config.platform.name="$PLATFORM_NAME"
      -Dtest.config.platform.version="$PLATFORM_VERSION"
      -Dtest.config.remote=true
      -Dfile.encoding=UTF-8 || true
    # Allow failure in tests and pass when there are test results (Quality Time should report on failed test)
    - compgen -G "build/test-results/test/*.xml"
  variables:
    APP_IDENTIFIER: "nl.ictu.edi.wallet.latest"
    DEVICE_NAME: "Google Pixel 8"
    PLATFORM_NAME: "Android"
    PLATFORM_VERSION: "14.0"
  needs:
    - job: build-wallet-provider-image
      artifacts: false
      optional: true
    - job: build-wp-migrations-image
      artifacts: false
      optional: true
    - job: build-ws-migrations-image
      artifacts: false
      optional: true
    - job: build-mock-relying-party-image
      artifacts: false
      optional: true
    - job: build-wallet-server-image
      artifacts: false
      optional: true
    - job: build-verification-server-image
      artifacts: false
      optional: true
    - job: build-pid-issuer-image
      artifacts: false
      optional: true
  rules:
    - !reference [.on-schedule, rules]
    - !reference [.on-web-trigger, rules]

run-automation-tests-suite-appstart:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.AppStartTestSuite" }

run-automation-tests-suite-introduction:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.IntroductionTestSuite" }

run-automation-tests-suite-security:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.SecurityTestSuite" }

run-automation-tests-suite-confirm:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.ConfirmTestSuite" }

run-automation-tests-suite-personalize:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.PersonalizeTestSuite" }

run-automation-tests-suite-dashboard:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.DashboardTestSuite" }

run-automation-tests-suite-card:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.CardTestSuite" }

run-automation-tests-suite-menu:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.MenuTestSuite" }

run-automation-tests-suite-history:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.HistoryTestSuite" }

run-automation-tests-suite-settings:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.SettingsTestSuite" }

run-automation-tests-suite-lock:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.LockTestSuite" }

run-automation-tests-suite-web:
  extends: .run-automation-tests-default
  variables: { TESTS: "suite.WebTestSuite" }

run-automation-tests-publish-results:
  rules: !reference [.run-automation-tests-default, rules]
  needs:
    - { job: run-automation-tests-suite-appstart }
    - { job: run-automation-tests-suite-introduction }
    - { job: run-automation-tests-suite-security }
    - { job: run-automation-tests-suite-confirm }
    - { job: run-automation-tests-suite-personalize }
    - { job: run-automation-tests-suite-dashboard }
    - { job: run-automation-tests-suite-card }
    - { job: run-automation-tests-suite-menu }
    - { job: run-automation-tests-suite-history }
    - { job: run-automation-tests-suite-settings }
    - { job: run-automation-tests-suite-lock }
    - { job: run-automation-tests-suite-web }
  script:
    - zip e2e.zip uiautomation/build/test-results/test/*.xml
    - deploy/bin/store-artifact.sh e2e.zip qt/quality-time/junit-results/

run-automation-smoke-test-ont:
  extends: .run-automation-tests-common-setup
  rules: !reference [.default-branch, rules]
  needs:
    - job: upload-browserstack-android-app-ont
      artifacts: false
    - job: deploy-mock-relying-party-ont
      artifacts: false
    - job: deploy-wallet-provider-ont
      artifacts: false
    - job: deploy-pid-issuer-ont
      artifacts: false
  script:
    - ./gradlew --no-daemon --info --stacktrace smokeTest
      -Dtest.config.app.identifier="${APP_IDENTIFIER}_${CI_COMMIT_SHA}"
      -Dtest.config.device.name="$DEVICE_NAME"
      -Dtest.config.platform.name="$PLATFORM_NAME"
      -Dtest.config.platform.version="$PLATFORM_VERSION"
      -Dtest.config.remote=true
      -Dfile.encoding=UTF-8
  variables: !reference [.run-automation-tests-default, variables]

run-gba-fetch-browsertest-test-ont:
  rules:
    - !reference [.on-schedule, rules]
  extends: .env-ont-k8s
  before_script: |
    kubectl get secret nl-wallet-gba-fetch-browsertest-ont-client-secret -o jsonpath="{.data.gba_fetch_e2e\.p12}" | base64 -d > browsertests/packages/gba-fetch/config/gba_fetch_client_cert_ont.p12
    export GBA_FETCH_FRONTEND_CLIENT_CERT_PATH="./gba_fetch_client_cert_ont.p12"
    export GBA_FETCH_FRONTEND_CLIENT_CERT_PASSPHRASE=$(kubectl get secret nl-wallet-gba-fetch-browsertest-ont-client-secret -o jsonpath='{.data.passphrase}' | base64 --decode)
  script: |
    cd browsertests
    npm ci
    cd packages/gba-fetch
    npx playwright install chromium
    npm run test:authenticated
    npm run test:unauthenticated
  after_script: |
    mkdir -p browsertests-junit
    cp browsertests/packages/gba-fetch/test-results-authenticated/results_authenticated.xml browsertest-junit/
    cp browsertests/packages/gba-fetch/test-results-unauthenticated/results_unauthenticated.xml browsertest-junit/
    zip -r browsertest.zip browsertests-junit
    deploy/bin/store-artifact.sh browsertest.zip qt/quality-time/junit-results/browsertest.zip
  artifacts:
    when: always
    paths:
      - browsertests/packages/gba-fetch/test-results*/
    reports:
      junit: browsertests/packages/gba-fetch/test-results*/*.xml

run-performance-test-ont:
  rules: !reference [.default-branch, rules]
  extends: .env-ont-k8s
  needs:
    - job: deploy-mock-relying-party-ont
      artifacts: false
    - job: deploy-wallet-provider-ont
      artifacts: false
    - job: deploy-pid-issuer-ont
      artifacts: false
    - job: wallet-config-ont
      artifacts: true
  variables:
    CONFIG_ENV: ont
    UNIVERSAL_LINK_BASE: "https://$APP_EXTERNAL_HOSTNAME_ONT/deeplink/"
    RELYING_PARTY_URL: "https://${EXTERNAL_HOSTNAME_ONT}/${MOCK_RELYING_PARTY_EXTERNAL_CONTEXT_PATH}/"
    PUBLIC_WALLET_SERVER_URL: "https://${EXTERNAL_HOSTNAME_ONT}/${MRP_VERIFICATION_SERVER_EXTERNAL_CONTEXT_PATH}/"
    INTERNAL_WALLET_SERVER_URL: "https://${MRP_VERIFICATION_SERVER_INTERNAL_HOSTNAME_ONT}/"
    APPLE_ATTESTATION_ENVIRONMENT: "production"
  script: |
    cd ./wallet_core/
    cargo build --release --bin performance_test --features performance_test,allow_insecure_url
    export PT_START_DATE=$(date -u +%s)
    bash ./tests_integration/run_performance_test.sh 100
    export PT_END_DATE=$(date -u +%s)
    export PT_DURATION=$(( PT_END_DATE - PT_START_DATE ))
    echo "Load: 100"
    echo "Duration: ${PT_DURATION} seconds"
  allow_failure: true
