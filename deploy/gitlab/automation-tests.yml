automation-compile-check:
  rules: !reference [.merge-request, rules]
  script:
    - java -version
    - cd uiautomation
    - ./gradlew --no-daemon compileTestKotlin

scheduled-automation-tests-trigger:
  rules:
    - !reference [.default-or-release, rules]
  needs:
    - job: deploy-apps-ont
      artifacts: false
      optional: true
  trigger:
    include:
      - local: .gitlab-ci.yml
  variables:
    SCHEDULED: automation
  when: manual
  allow_failure: true

.run-automation-tests-base:
  extends: .env-k8s
  before_script:
    - BROWSERSTACK_USER=$(kubectl get secret nl-wallet-browserstack -o jsonpath='{.data.user}' | base64 --decode)
    - export BROWSERSTACK_USER
    - BROWSERSTACK_KEY=$(kubectl get secret nl-wallet-browserstack -o jsonpath='{.data.key}' | base64 --decode)
    - export BROWSERSTACK_KEY
    - java -version
    - cd uiautomation
    - set -euxo pipefail
  variables:
    APP_IDENTIFIER: "nl.ictu.edi.wallet.latest"

.run-automation-tests-common-setup:
  resource_group: automation-tests
  extends: .run-automation-tests-base
  artifacts:
    name: uiautomation
    when: always
    paths:
      - uiautomation/build/test-results/**/*.xml
      - uiautomation/build/allure-results
      - uiautomation/build/reports
    reports:
      junit: uiautomation/build/test-results/**/*.xml

.run-automation-tests-default:
  extends: .run-automation-tests-common-setup
  script:
    - mv browserstack-config/browserstack-oneplus12r-14-NL.yml ./browserstack.yml
    - ./gradlew --no-daemon --info --stacktrace test --tests $TESTS
      -Dtest.config.remote=true
      -Dfile.encoding=UTF-8 || true
    # Allow failure in tests and pass when there are test results (Quality Time should report on failed test)
    - compgen -G "build/test-results/test/*.xml"
  rules:
    - !reference [.on-schedule-automation, rules]

run-automation-tests-publish-results:
  rules: !reference [.run-automation-tests-default, rules]
  needs:
    - { job: run-automation-card-and-history-tests }
    - { job: run-automation-disclosure-tests }
    - { job: run-automation-introduction-tests }
    - { job: run-automation-issuance-tests }
    - { job: run-automation-menu-and-settings-tests }
    - { job: run-automation-open-app-tests }
    - { job: run-automation-security-tests }
  script:
    - deploy/bin/store-artifact-zip.sh qt/quality-time/junit-results/e2e.zip uiautomation/build/test-results/test/*.xml
    - deploy/bin/store-artifact-zip.sh qt/quality-time/allure-results/e2e.zip uiautomation/build/allure-results/*

run-automation-card-and-history-tests:
  extends: .run-automation-tests-default
  variables:
    TESTS: "suite.CardsAndHistoryTestSuite"

run-automation-disclosure-tests:
  extends: .run-automation-tests-default
  variables:
    TESTS: "suite.DisclosureTestSuite"

run-automation-introduction-tests:
  extends: .run-automation-tests-default
  variables:
    TESTS: "suite.IntroductionTestSuite"

run-automation-issuance-tests:
  extends: .run-automation-tests-default
  variables:
    TESTS: "suite.IssuanceTestSuite"

run-automation-menu-and-settings-tests:
  extends: .run-automation-tests-default
  variables:
    TESTS: "suite.MenuAndSettingsTestSuite"

run-automation-open-app-tests:
  extends: .run-automation-tests-default
  variables:
    TESTS: "suite.OpenAppTestSuite"

run-automation-security-tests:
  extends: .run-automation-tests-default
  variables:
    TESTS: "suite.SecurityTestSuite"

run-automation-english-tests:
  extends: .run-automation-tests-common-setup
  script:
    - mv browserstack-config/browserstack-oneplus12r-14-EN.yml ./browserstack.yml
    - ./gradlew --no-daemon --info --stacktrace testEnglish
      -Dtest.config.remote=true
      -Dfile.encoding=UTF-8 || true
    # Allow failure in tests and pass when there are test results (Quality Time should report on failed test)
    - compgen -G "build/test-results/test/*.xml"
  rules:
    - !reference [.on-schedule-automation, rules]

run-automation-smoke-test-ont:
  extends: .run-automation-tests-common-setup
  rules: !reference [.default-branch, rules]
  needs:
    - job: upload-browserstack-android-app
      artifacts: false
    - job: deploy-apps-ont
      artifacts: false
  script:
    - mv browserstack-config/browserstack-oneplus12r-14-NL.yml ./browserstack.yml
    - ./gradlew --no-daemon --info --stacktrace smokeTest
      -Dtest.config.remote=true
      -Dfile.encoding=UTF-8

run-automation-smoke-test-ios-ont:
  extends: .run-automation-tests-common-setup
  rules: !reference [.default-branch, rules]
  needs:
    - job: upload-browserstack-ios-app
      artifacts: false
    - job: deploy-apps-ont
      artifacts: false
  script:
    - mv browserstack-config/browserstack-Iphone16Pro-18-NL.yml ./browserstack.yml
    - ./gradlew --no-daemon --info --stacktrace smokeTestIOS
      -Dtest.config.remote=true
      -Dfile.encoding=UTF-8

browsertests-format-lint:
  rules: !reference [.default-or-merge-request, rules]
  image: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/nl-wallet-app-builder-ci-node:${BUILD_TAG}"
  script:
    - cd browsertests
    - npm ci
    - npm run format-check
    - npm run lint

.run-browsertest-common:
  image: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/nl-wallet-app-builder-ci-playwright:${BUILD_TAG}"
  extends: .env-k8s
  needs:
    - job: build-env-ont
      artifacts: true

run-wallet-web-browsertest-test-ont:
  extends: .run-browsertest-common
  rules:
    - !reference [.default-branch, rules]
  needs:
    - !reference [.run-browsertest-common, needs]
    - job: deploy-apps-ont
      artifacts: false
  script: |
    cd browsertests
    npm ci
    cd packages/wallet-web
    npx playwright install chromium webkit
    npm run test:ci
  after_script:
    - deploy/bin/store-artifact.sh browsertests/packages/wallet-web/test-results/results.xml qt/quality-time/junit-results/browsertest-wallet-web.xml
    - deploy/bin/store-artifact-zip.sh qt/quality-time/allure-results/browsertest-wallet-web.zip browsertests/packages/wallet-web/allure-results/*
  artifacts:
    name: browsertest-wallet-web
    when: always
    paths:
      - browsertests/packages/wallet-web/test-results/
      - browsertests/packages/wallet-web/allure-results/
    reports:
      junit: browsertests/packages/wallet-web/test-results/*.xml

run-fallback-pages-browsertest-test-ont:
  extends: .run-browsertest-common
  rules:
    - !reference [.default-branch, rules]
  needs:
    - !reference [.run-browsertest-common, needs]
    - job: deploy-apps-ont
      artifacts: false
  script: |
    cd browsertests
    npm ci
    cd packages/fallback-pages
    npx playwright install chromium webkit
    npm run test:ci
  after_script:
    - deploy/bin/store-artifact.sh browsertests/packages/fallback-pages/test-results/results.xml qt/quality-time/junit-results/browsertest-fallback-pages.xml
    - deploy/bin/store-artifact-zip.sh qt/quality-time/allure-results/browsertest-fallback-pages.zip browsertests/packages/fallback-pages/allure-results/*
  artifacts:
    name: browsertest-fallback-page
    when: always
    paths:
      - browsertests/packages/fallback-pages/test-results/
      - browsertests/packages/fallback-pages/allure-results/
    reports:
      junit: browsertests/packages/fallback-pages/test-results/*.xml

run-performance-test-ont:
  extends: .env-k8s
  rules: !reference [.default-branch, rules]
  needs:
    - job: build-performance-test
      artifacts: true
    - job: deploy-apps-ont
      artifacts: false
  script: wallet_core/tests_integration/run_performance_test.sh --skip-build
  allow_failure: true
