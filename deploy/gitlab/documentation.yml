build-documentation:
  rules: !reference [.default-or-release-or-merge-request-manual, rules]
  script:
    - cd documentation
    - python3 -m venv venv
    - source venv/bin/activate
    - pip3 install -r requirements.txt
    - make linkcheck
    - sphinx-build -b html -W . _build/html
  artifacts:
    name: documentation
    when: always
    paths:
      - documentation/_build/html
  allow_failure: true

generate-c4-puml:
  rules: !reference [.default-or-release-or-merge-request-manual, rules]
  image:
    name: "${HARBOR_REGISTRY}/docker-hub-proxy/structurizr/cli:latest"
    entrypoint: [""]
  script:
    - mkdir -p c4diagrams
    - /usr/local/structurizr-cli/structurizr.sh export --workspace documentation/_structurizr/workspace.dsl --output c4diagrams --format plantuml
    - echo "Generated .puml files:"
    - ls -l c4diagrams
  artifacts:
    paths:
      - c4diagrams/
    expire_in: 1 week

generate-c4-png:
  rules: !reference [.default-or-release-or-merge-request-manual, rules]
  image:
    name: "${HARBOR_REGISTRY}/docker-hub-proxy/plantuml/plantuml:latest"
    entrypoint: [""]
  needs:
    - job: generate-c4-puml
      artifacts: true
  script:
    - echo "Rendering PNGs from .puml files using java -jar..."
    - find c4diagrams -name '*.puml' -exec java -jar /opt/plantuml.jar -tpng {} +
    - echo "Generated PNG files:"
    - ls -l c4diagrams
  artifacts:
    paths:
      - c4diagrams/
    expire_in: 1 week

publish-documentation:
  rules: !reference [.default-branch, rules]
  needs:
    - job: build-documentation
      artifacts: true
  script:
    - git clone --branch documentation --depth 1 https://$GITHUB_BOT_USER:$GH_TOKEN@github.com/MinBZK/nl-wallet.git public
    - cd public
    - rm -rf *
    - mv ../documentation/_build/html/* .
    - git add .
    - |
      if [[ -n $(git status --porcelain) && $CI_COMMIT_BRANCH == "$CI_DEFAULT_BRANCH" ]]; then
        git config user.name 'NL Wallet'
        git config user.email "$GITHUB_BOT_EMAIL"
        git commit -m "Update documentation"
        git push origin documentation;
      else
        git status
      fi
  allow_failure: true
