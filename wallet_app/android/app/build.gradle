plugins {
    id "com.android.application"
    id "kotlin-android"
    id "dev.flutter.flutter-gradle-plugin"
}

def keystoreProperties = new Properties()
def keystorePropertiesFile = rootProject.file('key.properties')
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

def localProperties = new Properties()
def localPropertiesFile = rootProject.file('local.properties')
if (localPropertiesFile.exists()) {
    localPropertiesFile.withReader('UTF-8') { reader ->
        localProperties.load(reader)
    }
}

def flutterVersionCode = localProperties.getProperty('flutter.versionCode')
if (flutterVersionCode == null) {
    flutterVersionCode = '1'
}

def flutterVersionName = localProperties.getProperty('flutter.versionName')
if (flutterVersionName == null) {
    flutterVersionName = '1.0'
}

def dartEnvironmentVariables = []
if (project.hasProperty('dart-defines')) {
    dartEnvironmentVariables = project.property('dart-defines')
            .split(',')
            .collectEntries { entry ->
                def pair = new String(entry.decodeBase64(), 'UTF-8').split('=')

                // Check if the pair actually contains 2 values, else return empty string as value.
                [(pair.first()): pair.size() == 2 ? pair.last() : '']
            }
}

// Universal / deep links config
def ulHostname = dartEnvironmentVariables['UL_HOSTNAME']
def ulHostnameIsSet = ulHostname != null && !ulHostname.isEmpty()

def ulIntentFilterAutoVerify = ulHostnameIsSet
def ulIntentFilterHost = ulHostnameIsSet ? ulHostname : '*'
def ulIntentFilterPathPrefix = ulHostnameIsSet ? '/deeplink' : ''
def ulIntentFilterScheme = ulHostnameIsSet ? 'https' : 'walletdebuginteraction'

android {
    namespace "nl.rijksoverheid.edi.wallet"
    compileSdk 34

    // Note: When using flutter >= 3.27.1 with Java 21, you will see the
    // following (harmless) warnings:
    //
    //   warning: [options] source value 8 is obsolete and will be removed in a future release
    //   warning: [options] target value 8 is obsolete and will be removed in a future release
    //
    // This will be fixed in a future flutter version, see:
    // https://github.com/flutter/flutter/issues/156111
    //
    // The above warnings are not due to these jvmTarget, sourceCompatibility,
    // and targetCompatibility options, but due to the flutter gradle plugin.
    // When the above-linked issue is merged and released, the above warnings
    // should disappear.
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_11
        targetCompatibility JavaVersion.VERSION_11
    }

    kotlinOptions {
        jvmTarget = '11'
        freeCompilerArgs = ["-Xstring-concat=inline"]
    }

    sourceSets {
        main {
            // Include native libraries
            jniLibs.srcDirs += 'src/main/jniLibs'
        }
    }

    packagingOptions {
        // Exclude the platform_support.so files that are added by the
        // platform_support module, as this code is also in libwallet_core.so
        jniLibs {
            excludes += "**/libplatform_support.so"
        }
    }

    defaultConfig {
        applicationId "nl.ictu.edi.wallet.latest"
        // You can update the following values to match your application needs.
        // For more information, see: https://docs.flutter.dev/deployment/android#reviewing-the-build-configuration.
        minSdk 24
        targetSdk 34
        versionCode flutterVersionCode.toInteger()
        versionName flutterVersionName

        // Set universal & deep links intent-filter placeholders
        manifestPlaceholders['ulIntentFilterAutoVerify'] = ulIntentFilterAutoVerify
        manifestPlaceholders['ulIntentFilterHost'] = ulIntentFilterHost
        manifestPlaceholders['ulIntentFilterPathPrefix'] = ulIntentFilterPathPrefix
        manifestPlaceholders['ulIntentFilterScheme'] = ulIntentFilterScheme
    }

    signingConfigs {
        common {
            keyAlias keystoreProperties['keyAlias']
            keyPassword keystoreProperties['keyPassword']
            storeFile keystoreProperties['storeFile'] ? file('../' + keystoreProperties['storeFile']) : null
            storePassword keystoreProperties['storePassword']
        }
    }

    buildFeatures {
        buildConfig = true
    }

    // Debug and Profile builds use release keys if they're available, auto-available debug keys if not.
    // Release build needs release keys (i.e., wallet_app/android/key.properties, wallet_app/android/keystore/local-keystore.jks).
    buildTypes {
        debug {
            keystoreProperties["storeFile"] ? (signingConfig signingConfigs.common) : (signingConfig signingConfigs.debug)
            logger.quiet("Build type ${name}, using keystore: ${signingConfig.storeFile}")

            packagingOptions {
                doNotStrip "**/*.so"
            }
        }
        profile {
            keystoreProperties["storeFile"] ? (signingConfig signingConfigs.common) : (signingConfig signingConfigs.debug)
            logger.quiet("Build type ${name}, using keystore: ${signingConfig.storeFile}")
        }
        release {
            signingConfig signingConfigs.common
            logger.quiet("Build type ${name}, using keystore: ${signingConfig.storeFile}")
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'

            ndk {
                abiFilters "arm64-v8a", "armeabi-v7a", "x86_64"
            }
        }
    }
}

flutter {
    source '../..'
}

dependencies {
    implementation "net.java.dev.jna:jna:5.7.0@aar" // Java Native Access

    implementation project(path: ':platform_support')
}

// Target directory for the Rust library files
def jniTargetDir = "${project.projectDir}/src/main/jniLibs"

// Register tasks to build the Rust code and copy the resulting library files
[
        Debug  : [false, null],
        Profile: [true, ['--locked', '--release']],
        Release: [true, ['--locked', '--release']]
].each {
    def taskPostfix = it.key
    def (doStrip, profileMode) = it.value
    tasks.whenTaskAdded { task ->
        if (task.name == "signReleaseBundle") {
            task.dependsOn "checkFor${taskPostfix}Keys"
        }
        if (task.name == "pre${taskPostfix}Build") {
            task.dependsOn "cargoBuildNativeLibrary$taskPostfix"
        }
    }
    tasks.register("checkFor${taskPostfix}Keys")
    tasks.named("checkFor${taskPostfix}Keys") {
        doFirst() {
            if (taskPostfix == "Release" && !keystorePropertiesFile.exists()) {
                throw new GradleException("Attempting a ${taskPostfix} build and ${keystorePropertiesFile} does not exist, Failing build..")
            }
        }
    }
    tasks.register("cargoBuildNativeLibrary$taskPostfix", Exec) {
        workingDir "../../../wallet_core"

        // Build the Rust code (wallet_core)
        executable = 'cargo'
        args = ['ndk',
                '-t', 'armeabi-v7a',
                '-t', 'arm64-v8a',
                '-t', 'x86_64',
                '-o', jniTargetDir
        ]
        if (!doStrip) {
            args += '--no-strip'
        }
        args += [
                'build',
                '-p', 'flutter_api'
        ]
        if (profileMode != null) {
            args += profileMode
        }
        if (dartEnvironmentVariables['ALLOW_INSECURE_URL'] == 'true') {
            args += ['--features', 'wallet/allow_insecure_url']
        }
    }
}

clean.doFirst {
    println "Cleaning $jniTargetDir"
    delete jniTargetDir
}
